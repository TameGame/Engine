<!DOCTYPE html>
<html>
    <!-- Simple test page for the WebGL renderer -->
    <head>
        <script src="../TameGame.js" type="text/javascript"></script>
    </head>
    <body>
        <canvas width=1280 height=720 id="testCanvas"></canvas>
        
        <script type="text/js-game" id="game">
            console.log("Hello!");
        </script>
        
        <script type="text/javascript">
            try {
                var canvas = document.getElementById("testCanvas");
                var renderer = new TameGame.WebGlRenderer(canvas);
            } catch (e) {
                alert(e);
            }
            
            var launched = TameGame.GameLauncher.launch(null, canvas, { launchScript: "../TameLaunch.js" });
            setTimeout(function() { launched.cancel(); console.log("Game cancelled"); }, 60000);
            
            var game        = new TameGame.StandardGame();
            var rotation    = 0;
            var someSprite  = renderer.sprites.loadSprite("TameGame.png");
            
            // Set up the camera every time we get a render
            game.events.onRender(function(queue) {
                queue.moveCamera(-1, { x:0, y: 0 }, 4.0, rotation);
            });
            
            // Call the WebGL renderer to actually perform the rendering
            game.events.onPerformRender(function(queue) {
                renderer.performRender(queue);
            });
            
            // Create a sprite object
            var spriteObject = game.createObject();
            spriteObject.get(TameGame.Sprite).assetId = someSprite;
            spriteObject.get(TameGame.Position).set({
                zIndex: 0,
                x1: -1, y1: 1,
                x2: 1, y2: 1,
                x3: -1, y3: -1,
                x4: 1, y4: -1
            });
            
            // Put it in a scene
            var scene = game.createScene();
            scene.addObject(spriteObject);
            
            game.startScene(scene);

            var frames = 0;
            var startTime = -1;
            function nextRender(now) {
                // Do no more frames after the rotation exceeds 720
                var moreFrames = true;
                if (rotation >= 720) {
                    rotation = 720;
                    moreFrames = false;
                }
                
                frames++;
                if (startTime < 0) startTime = now;
                
                if ((frames%60) === 0 || !moreFrames) {
                    console.log((frames / ((now-startTime)/1000.0)) + "fps");
                    frames = 0;
                    startTime = now;
                }
                
                // Advance the game state
                game.tick(now);
                
                // Set the new rotation
                rotation = ((now/10000) * 360);
                
                // Request more frames
                if (moreFrames) {
                    requestAnimationFrame(nextRender, canvas);
                }
            }
            
            requestAnimationFrame(nextRender, canvas);
        </script>
    </body>
</html>